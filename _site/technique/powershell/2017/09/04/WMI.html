<!DOCTYPE html>
<html lang="en">

  



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/cs_style.css">
<link rel="stylesheet" href="/assets/css/post.css">
<link rel="stylesheet" href="/assets/css/syntax.css">
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>


  <body>

    <div class="container">
  <nav class="navbar navbar-default navbar-toggleable-md navbar-light bg-white">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#containerNavbar" aria-controls="containerNavbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="/">K3Y6REAK</a>

  <div class="collapse navbar-collapse flex-row-reverse" id="containerNavbar">
    <ul class="navbar-nav my-2 my-md-0">
      <li class="nav-item active">
        <a class="nav-link" href="/about.html">About</a>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown04" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Programming</a>
        <div class="dropdown-menu" aria-labelledby="dropdown04">
          <a class="dropdown-item" href="/programming/c">C</a>
          <a class="dropdown-item" href="/programming/cpp">C++</a>
          <a class="dropdown-item" href="/programming/python">Python</a>
          <a class="dropdown-item" href="/programming/ruby">Ruby</a>
        </div>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown04" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">High Level Technique</a>
        <div class="dropdown-menu" aria-labelledby="dropdown04">
          <a class="dropdown-item" href="/technique/reversing">Reversing</a>
          <a class="dropdown-item" href="/technique/android">Android</a>
          <a class="dropdown-item" href="/technique/system_hacking">System Hacking</a>
          <a class="dropdown-item" href="/technique/powershell">PowerShell</a>
          <a class="dropdown-item" href="/technique/web_hacking">Web Hacking</a>
          <a class="dropdown-item" href="/technique/shellcoding">Shellcoding</a>
          <a class="dropdown-item" href="/technique/windows_system">Windows System</a>
          <a class="dropdown-item" href="/technique/windows_forensic">Windows Forensic</a>
          <a class="dropdown-item" href="/technique/linux_forensic">Linux Forensic</a>
        </div>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown04" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Wargame</a>
        <div class="dropdown-menu" aria-labelledby="dropdown04">
          <a class="dropdown-item" href="/wargame/reversing_kr">reversing.kr</a>
          <a class="dropdown-item" href="/wargame/pwnable_kr">pwnable.kr</a>
          <a class="dropdown-item" href="/wargame/wargame_kr">wargame.kr</a>
        </div>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="/ctfs">CTFs</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="/misc">MISC</a>
      </li>

    </ul>
  </div>
</nav>
</div>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">WMI</h1>
    <p class="post-meta">
      <time datetime="2017-09-04T20:01:00+09:00" itemprop="datePublished">
        
        Sep 4, 2017
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><br /><br /></p>

<p><code class="highlighter-rouge">WMI</code>는 Windows Management Instrumentation으로 <code class="highlighter-rouge">윈도우 관리 도구</code>다. 이를 PowerShell에서 사용할 수 있는데 <code class="highlighter-rouge">Get-WmiObject</code>명령을 이용한다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Namespace "root" -Class "__Namespace"


__GENUS          : 2
__CLASS          : __NAMESPACE
__SUPERCLASS     : __SystemClass
__DYNASTY        : __SystemClass
__RELPATH        : __NAMESPACE.Name="subscription"
__PROPERTY_COUNT : 1
__DERIVATION     : {__SystemClass}
__SERVER         : K3Y6REAK9778
__NAMESPACE      : ROOT
__PATH           : \\K3Y6REAK9778\ROOT:__NAMESPACE.Name="subscription"
Name             : subscription
PSComputerName   : K3Y6REAK9778

__GENUS          : 2
__CLASS          : __NAMESPACE
__SUPERCLASS     : __SystemClass
__DYNASTY        : __SystemClass
__RELPATH        : __NAMESPACE.Name="DEFAULT"
__PROPERTY_COUNT : 1
__DERIVATION     : {__SystemClass}
__SERVER         : K3Y6REAK9778
__NAMESPACE      : ROOT
__PATH           : \\K3Y6REAK9778\ROOT:__NAMESPACE.Name="DEFAULT"
Name             : DEFAULT
PSComputerName   : K3Y6REAK9778</code></pre></figure>

<p>여기서 이름에 대한 내용만 가져오고 싶은 경우 <code class="highlighter-rouge">| Select-Object Name</code>를 붙여주면 된다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Namespace "root" -Class "__Namespace" | Select-Object Name

Name
----
subscription
DEFAULT
CIMV2
msdtc
Cli
SECURITY
SecurityCenter2
RSOP
PEH
StandardCimv2
WMI
directory
Policy
Interop
Hardware
ServiceModel
SecurityCenter
Microsoft
aspnet
Appv</code></pre></figure>

<p>Wmi-Object 중에서 CIMV2에 대한 내용을 살펴보자.</p>

<p><code class="highlighter-rouge">Get-WmiObject -NameSpace "root/cimv2" -List</code>를 입력하면 아래와 같은 수많은 항목을 볼 수 있다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -NameSpace "root/cimv2" -List


   NameSpace: ROOT\CIMV2

Name                                Methods              Properties
----                                -------              ----------
__SystemClass                       {}                   {}
__thisNAMESPACE                     {}                   {SECURITY_DESCRIPTOR}
__Provider                          {}                   {Name}
__Win32Provider                     {}                   {ClientLoadableCLSID, CLSID, Concurrency, DefaultMachineName...}
__ProviderRegistration              {}                   {provider}
__EventProviderRegistration         {}                   {EventQueryList, provider}
__ObjectProviderRegistration        {}                   {InteractionType, provider, QuerySupportLevels, SupportsBatching...}
__ClassProviderRegistration         {}                   {CacheRefreshInterval, InteractionType, PerUserSchema, provider...}
__InstanceProviderRegistration      {}                   {InteractionType, provider, QuerySupportLevels, SupportsBatching...}

...(생략)</code></pre></figure>

<p>여기서 Win32에 대한 항목을 보고 싶다면 <code class="highlighter-rouge">| Where-Object {$_.Name -match "Win32}</code>를 붙여주면 된다. 마찬가지로 많은 항목이 출력된다. 이 중 Win32_Process을 사용해 보자.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Class Win32_Process</code>를 실행하면 이 또한 많은 항목이 출력된다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">__GENUS                    : 2
__CLASS                    : Win32_Process
__SUPERCLASS               : CIM_Process
__DYNASTY                  : CIM_ManagedSystemElement
__RELPATH                  : Win32_Process.Handle="604"
__PROPERTY_COUNT           : 45
__DERIVATION               : {CIM_Process, CIM_LogicalElement, CIM_ManagedSystemElement}
__SERVER                   : K3Y6REAK9778
__NAMESPACE                : root\cimv2
__PATH                     : \\K3Y6REAK9778\root\cimv2:Win32_Process.Handle="604"
Caption                    : wininit.exe
CommandLine                :
CreationClassName          : Win32_Process
CreationDate               : 20170813174441.546153+540
CSCreationClassName        : Win32_ComputerSystem
CSName                     : K3Y6REAK9778
Description                : wininit.exe
ExecutablePath             :
ExecutionState             :
Handle                     : 604
HandleCount                : 152
InstallDate                :
KernelModeTime             : 12343750
MaximumWorkingSetSize      :
MinimumWorkingSetSize      :
Name                       : wininit.exe
OSCreationClassName        : Win32_OperatingSystem
OSName                     : Microsoft Windows 10 Education|C:\WINDOWS|\Device\Harddisk0\Partition4
OtherOperationCount        : 17201
OtherTransferCount         : 4702606
PageFaults                 : 6127
PageFileUsage              : 1704
ParentProcessId            : 500
PeakPageFileUsage          : 2200
PeakVirtualSize            : 2199082618880
PeakWorkingSetSize         : 7188
Priority                   : 13
PrivatePageCount           : 1744896
ProcessId                  : 604
QuotaNonPagedPoolUsage     : 12
QuotaPagedPoolUsage        : 120
QuotaPeakNonPagedPoolUsage : 15
QuotaPeakPagedPoolUsage    : 122
ReadOperationCount         : 22
ReadTransferCount          : 56320
SessionId                  : 0
Status                     :
TerminationDate            :
ThreadCount                : 1
UserModeTime               : 0
VirtualSize                : 2199078547456
WindowsVersion             : 10.0.15063
WorkingSetSize             : 4096
WriteOperationCount        : 0
WriteTransferCount         : 0
PSComputerName             : K3Y6REAK9778
ProcessName                : wininit.exe
Handles                    : 152
VM                         : 2199078547456
WS                         : 4096
Path                       :</code></pre></figure>

<p>이름만 출력하고 싶다면 <code class="highlighter-rouge">| select Name</code>을 붙여주면 된다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Class Win32_Process | Select Name

Name
----
System Idle Process
System
smss.exe
csrss.exe
wininit.exe
services.exe
lsass.exe
svchost.exe
svchost.exe
fontdrvhost.exe
svchost.exe
svchost.exe
svchost.exe
svchost.exe
WUDFHost.exe
...(생략)</code></pre></figure>

<p>이 명령어을 이용해서 Win7의 정보를 가져올 수 있다.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Class Win32_Process -ComputerName [Win7 컴퓨터이름] -Credential [Win7 계정] | select Name</code></p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Class Win32_Process -ComputerName WIN-J9KO348JQVU -Credential k3y6reak | select Name

Name
----
System Idle Process
System
smss.exe
csrss.exe
wininit.exe
csrss.exe
winlogon.exe
services.exe
lsass.exe
lsm.exe
svchost.exe
vmacthlp.exe
svchost.exe
svchost.exe
svchost.exe
svchost.exe
audiodg.exe
svchost.exe
svchost.exe
spoolsv.exe
svchost.exe
VGAuthService.exe
vmtoolsd.exe
svchost.exe
dllhost.exe
dllhost.exe
WmiPrvSE.exe
msdtc.exe
taskhost.exe
dwm.exe
explorer.exe
vmtoolsd.exe
VSSVC.exe
SearchIndexer.exe
wmpnetwk.exe
svchost.exe
SearchProtocolHost.exe
SearchFilterHost.exe
WmiPrvSE.exe
WmiApSrv.exe
powershell.exe
conhost.exe
sppsvc.exe
svchost.exe</code></pre></figure>

<p>여러 프로세스 중 특정 한 프로세스만 출력하고 싶은 경우 여러가지 방법이 있다.</p>

<h4 id="-eq">-eq</h4>

<p>eq는 equal로 같은 문자열이 있는 것을 찾는다. 
<code class="highlighter-rouge">Get-WmiObject -Class Win32_Process | Where-Object {$_.Name -eq "powershell.exe"}</code>를 이용해 powershell.exe를 찾게된다.</p>

<h4 id="-filter">-Filter</h4>

<p>필터 또한 찾고자 하는 문자열을 찾아주는 기능을 한다.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Class Win32_Process -Filter {Name = "powershell.exe"}</code></p>

<h4 id="-query">-Query</h4>

<p>쿼리는 쿼리문을 이용하여 찾는 방법을 말한다.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Query {Select * from Win32_Process where name = "powershell.exe"}</code></p>

<p><code class="highlighter-rouge">eq, filter, query</code> 모두 동일한 결과를 출력한다.</p>

<p>WMI을 이용해서 프로세스를 실행시킬 수 있다. 먼저 Win32_Process에서 사용할 수 있는 Method를 살펴보자.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Class Win32_Process -List</code>를 입력한다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Class Win32_Process -List


   NameSpace: ROOT\cimv2

Name                                Methods              Properties
----                                -------              ----------
Win32_Process                       {Create, Terminat... {Caption, CommandLine, CreationClassName, CreationDate...}</code></pre></figure>

<p>Methods 항목에 Create, Termiat… 를 볼 수 있는데 사용할 수 있는 Method를 모두 보자.</p>

<p><code class="highlighter-rouge">Get-WmiObject -Class Win32_Process -List | Select-Object -ExpandProterty Methods</code>를 입력해 보자.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Get-WmiObject -Class Win32_Process -List | Select-Object -ExpandProperty Methods


Name          : Create
InParameters  : System.Management.ManagementBaseObject
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Constructor, Implemented, MappingStrings, Privileges...}

Name          : Terminate
InParameters  : System.Management.ManagementBaseObject
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Destructor, Implemented, MappingStrings, Privileges...}

Name          : GetOwner
InParameters  :
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Implemented, MappingStrings, ValueMap}

Name          : GetOwnerSid
InParameters  :
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Implemented, MappingStrings, ValueMap}

Name          : SetPriority
InParameters  : System.Management.ManagementBaseObject
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Implemented, MappingStrings, ValueMap}

Name          : AttachDebugger
InParameters  :
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Implemented, ValueMap}

Name          : GetAvailableVirtualSize
InParameters  :
OutParameters : System.Management.ManagementBaseObject
Origin        : Win32_Process
Qualifiers    : {Implemented, ValueMap}</code></pre></figure>

<p>위 출력결과를 보면 <code class="highlighter-rouge">Create, Terminate, GetOwner, GetOwnerSid, SetPriority, AttachDebugger, GetAvailableVirtualSize</code>를 사용할 수 있다.</p>

<p><code class="highlighter-rouge">Invoke-WmiMethod</code> 명령어를 통해서 notepad.exe를 실행해보자.</p>

<p><code class="highlighter-rouge">Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "notepad.exe"</code>를 입력해 보자.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "notepad.exe"


__GENUS          : 2
__CLASS          : __PARAMETERS
__SUPERCLASS     :
__DYNASTY        : __PARAMETERS
__RELPATH        :
__PROPERTY_COUNT : 2
__DERIVATION     : {}
__SERVER         :
__NAMESPACE      :
__PATH           :
ProcessId        : 2940
ReturnValue      : 0
PSComputerName   :</code></pre></figure>

<p><code class="highlighter-rouge">Invoke-WmiMethod</code> 또한 Win7에 notepad.exe를 실행할 수 있다.</p>

<figure class="highlight"><pre><code class="language-ps" data-lang="ps">PS C:\WINDOWS\system32&gt; Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "notepad.exe" -ComputerName WIN-J9KO348JQVU -Credential k3y6reak


__GENUS          : 2
__CLASS          : __PARAMETERS
__SUPERCLASS     :
__DYNASTY        : __PARAMETERS
__RELPATH        :
__PROPERTY_COUNT : 2
__DERIVATION     : {}
__SERVER         :
__NAMESPACE      :
__PATH           :
ProcessId        : 2420
ReturnValue      : 0
PSComputerName   :</code></pre></figure>

<p>실행 결과를 보면 실행이 된 것을 볼 수 있는데 실제 Win7에서 확인해보면 실행되지 않는다.</p>

<p>실행시킬 수 있는 방법에 대해서 알아봐야겠다.</p>


  </div>

  
</article>

      </div>
    </main>

    



<div class="container">
	<hr>
	<section class="float-left">
		&copy; 2017. SAHONG PAK all rights reserved.
	</section>
	<section class="float-right">
		<a href="http://blog.rebforpwn.com">
			<img src="/assets/img/rebforpwn.png" alt="RebForPwn" height="32" width="100">
		</a>

		<a href="http://">
		<img src="/assets/img/github.svg" alt="github" height="32" width="32">
		</a>

		<a href="mailto:k3y6reak@naver.com">
		<img src="/assets/img/mail.svg" alt="mail" height="32" width="32">
		</a>
	</section>
</div>

  </body>

</html>
